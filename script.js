document.addEventListener('DOMContentLoaded', function() {

    // --- Language and Translations ---
    let currentLanguage = 'zh';
    const translations = {
        en: {
            'page-title': 'LLM Carbon Footprint Calculator',
            'main-title': 'LLM Carbon Footprint Calculator',
            'sub-title': 'Integrated Carbon Emission Calculation for LLM Training, Inference, and Hardware Lifecycle',
            'developer-credit': 'Developed By Tzu-Hsuan Huang',
            'tab-lca': 'AI Chip LCA',
            'tab-training': 'LLM Training Emissions',
            'tab-inference': 'LLM Inference Emissions',
            'lca-settings-title': 'Parameter Settings',
            'lca-chip-model-label': 'Select AI Chip Model',
            'lca-lifespan-label': 'Estimated Lifespan (years)',
            'lca-lifespan-tooltip': 'The typical operational life of an AI chip in a data center or server environment, usually 5 years.',
            'lca-utilization-label': 'Daily Operating Hours',
            'lca-utilization-tooltip': 'The average time an AI chip spends on training or inference tasks per day. The recommended value is 24 hours.',
            'lca-carbon-intensity-label': 'Grid Carbon Intensity (kgCOâ‚‚e/kWh)',
            'lca-carbon-intensity-tooltip': 'The amount of carbon emissions produced per kilowatt-hour of electricity generated. The 2022 average for Taiwan is approx. 0.416 kgCOâ‚‚e/kWh.',
            'calculateLcaBtn': 'Calculate',
            'lca-results-title': 'Calculation Results',
            'lca-total-co2-label': 'Total Carbon Footprint',
            'lca-total-co2-tooltip': 'Total greenhouse gas emissions produced by the chip throughout its lifecycle, including manufacturing and operation.',
            'lca-water-label': 'Water Consumption',
            'lca-water-tooltip': 'Total water consumed during the manufacturing and operational phases of the chip\'s lifespan.',
            'lca-ewaste-label': 'E-Waste',
            'lca-ewaste-tooltip': 'The weight of waste generated by the chip at the end of its life, usually referring to the product\'s own weight.',
            'lca-breakdown-title': 'Carbon Emission Breakdown',
            'lca-op-co2-label': 'Operational Emissions',
            'lca-op-co2-tooltip': 'Carbon emissions generated from electricity consumption during the chip\'s operation.',
            'lca-em-co2-label': 'Embodied Emissions',
            'lca-em-co2-tooltip': 'Carbon emissions generated during the chip\'s manufacturing, transportation, and disposal phases.',
            'lca-equivalents-title': 'Daily Equivalents',
            'training-settings-title': 'Parameter Settings',
            'training-model-settings-title': '1. LLM Model Settings',
            'training-preset-label': 'Model Preset',
            'training-model-type-label': 'Model Type',
            'training-model-type-dense': 'Dense',
            'training-model-type-moe': 'MoE (Mixture of Experts)',
            'training-total-params-label': 'Total Parameters (B)',
            'training-total-params-tooltip': 'The total number of parameters in the model, in billions (B).',
            'training-base-params-label': 'Base Model Parameters (B)',
            'training-base-params-tooltip': 'For MoE models, the number of parameters in the corresponding dense base model.',
            'training-tokens-label': 'Tokens Processed (B)',
            'training-tokens-tooltip': 'The total number of tokens processed by the model during training or inference, in billions (B).',
            'training-hardware-settings-title': '2. Hardware & Data Center Settings',
            'training-device-label': 'Compute Device',
            'training-device-custom': 'Custom',
            'training-device-num-label': 'Number of Devices',
            'training-power-label': 'Avg. System Power (W/device)',
            'training-power-tooltip': 'The average total power consumption per compute device, including host, memory, etc.',
            'training-efficiency-label': 'Hardware Efficiency (%)',
            'training-efficiency-tooltip': 'The percentage of actual computational throughput relative to the theoretical peak throughput.',
            'training-pue-label': 'PUE',
            'training-pue-tooltip': 'Power Usage Effectiveness. The ratio of total data center energy consumption to IT equipment energy consumption. The closer to 1, the higher the efficiency.',
            'training-ci-label': 'Carbon Intensity (kgCOâ‚‚eq/kWh)',
            'training-ci-tooltip': 'The kilograms of carbon dioxide equivalent produced per kilowatt-hour (kWh) consumed by the data center. Default is the US average.',
            'training-cost-label': 'GPU Unit Cost ($/hour)',
            'training-cost-tooltip': 'The computational cost per GPU per hour. The default value is based on Microsoft Azure V100 pay-as-you-go pricing.',
            'calculateTrainingBtn': 'Calculate',
            'training-results-title': 'Calculation Results',
            'training-co2-label': 'Training Emissions',
            'training-co2-tooltip': 'Carbon emissions generated from electricity consumption during model training.',
            'training-energy-label': 'Total Energy Consumed',
            'training-energy-tooltip': 'The total amount of electricity consumed by the data center during model training.',
            'training-duration-label': 'Est. Training Time',
            'training-duration-tooltip': 'The total time required to complete model training.',
            'training-cost-est-label': 'Est. Training Cost',
            'training-cost-est-tooltip': 'The hardware rental cost required for model training (USD).',
            'training-equivalents-title': 'Daily Equivalents',
            'inf-settings-title': 'Parameter Settings',
            'inf-model-settings-title': '1. LLM Model Settings',
            'inf-preset-label': 'Select Model Preset',
            'inf-preset-custom': 'Custom',
            'inf-tokens-label': 'Tokens Processed',
            'inf-tokens-tooltip': 'Default token counts based on common task types.',
            'inf-task-rag': 'Q&A (RAG) (approx. 5k tokens)',
            'inf-task-translation': 'Translation (approx. 50k tokens)',
            'inf-task-code': 'Code Gen/Debug (approx. 20k tokens)',
            'inf-task-summary': 'Summarization (approx. 150k tokens)',
            'inf-model-type-label': 'Model Type',
            'inf-model-type-dense': 'Dense',
            'inf-model-type-moe': 'MoE (Mixture of Experts)',
            'inf-total-params-label': 'Total Parameters (B)',
            'inf-total-params-tooltip': 'The total number of parameters in the model, in billions (B).',
            'inf-base-params-label': 'Base Model Parameters (B)',
            'inf-base-params-tooltip': 'For MoE models, the number of parameters in the corresponding dense base model.',
            'inf-hardware-settings-title': '2. Hardware & Data Center Settings',
            'inf-device-label': 'Compute Device',
            'inf-device-custom': 'Custom',
            'inf-device-num-label': 'Number of Devices',
            'inf-power-label': 'Avg. System Power (W/device)',
            'inf-power-tooltip': 'The average total power consumption per compute device, including host, memory, etc.',
            'inf-efficiency-label': 'Hardware Efficiency (%)',
            'inf-efficiency-tooltip': 'The percentage of actual computational throughput relative to the theoretical peak throughput.',
            'inf-pue-label': 'PUE',
            'inf-pue-tooltip': 'Power Usage Effectiveness. The ratio of total data center energy consumption to IT equipment energy consumption. The closer to 1, the higher the efficiency.',
            'inf-ci-label': 'Carbon Intensity (gCOâ‚‚eq/kWh)',
            'inf-ci-tooltip': 'The grams of carbon dioxide equivalent produced per kilowatt-hour (kWh) consumed by the data center. Default is the US average.',
            'calculateInferenceBtn': 'Calculate',
            'inf-results-title': 'Calculation Results',
            'inf-total-co2-label': 'Total Carbon Footprint (gCOâ‚‚eq)',
            'inf-total-co2-tooltip': 'Total carbon emissions generated from electricity consumption during the model inference task.',
            'inf-details-title': 'Details',
            'inf-time-label': 'Est. Inference Time',
            'inf-time-tooltip': 'The total time required to complete the inference.',
            'inf-energy-label': 'Total Energy Consumed',
            'inf-energy-tooltip': 'The total amount of electricity consumed by the data center during model inference.',
            'inf-equivalents-title': 'Daily Equivalents',
            'unit_days': 'days',
            'unit_years': 'years',
            'unit_ms': 'ms',
            'unit_s': 's',
            'unit_min': 'min',
            'unit_hr': 'hr',
            'alert_invalid_input': 'Please enter valid numbers.',
            'chart_op_label': 'Operational Emissions',
            'chart_em_label': 'Embodied Emissions',
            'chart_title': 'Carbon Footprint Composition (tCOâ‚‚eq)',
            'model_preset_custom_name': 'Custom Model',
        },
        zh: {
            'page-title': 'LLM ç¢³è¶³è·¡è©•ä¼°å·¥å…·',
            'main-title': 'LLM ç¢³è¶³è·¡è©•ä¼°å·¥å…·',
            'sub-title': 'æ•´åˆ LLM è¨“ç·´ã€æŽ¨è«–åŠç¡¬é«”ç”Ÿå‘½é€±æœŸçš„ç¢³æŽ’è¨ˆç®—',
            'developer-credit': 'Developed By é»ƒå­ç‘„',
            'tab-lca': 'AI æ™¶ç‰‡ LCA',
            'tab-training': 'LLM è¨“ç·´ç¢³æŽ’',
            'tab-inference': 'LLM æŽ¨è«–ç¢³æŽ’',
            'lca-settings-title': 'åƒæ•¸è¨­å®š',
            'lca-chip-model-label': 'é¸æ“‡ AI æ™¶ç‰‡æ¨¡åž‹',
            'lca-lifespan-label': 'é ä¼°ä½¿ç”¨å¹´é™ (å¹´)',
            'lca-lifespan-tooltip': 'AI æ™¶ç‰‡åœ¨è³‡æ–™ä¸­å¿ƒæˆ–ä¼ºæœå™¨ç’°å¢ƒä¸­çš„å…¸åž‹é‹ä½œå£½å‘½ï¼Œé€šå¸¸ç‚º 5 å¹´ã€‚',
            'lca-utilization-label': 'æ¯æ—¥é‹ä½œæ™‚æ•¸ (å°æ™‚)',
            'lca-utilization-tooltip': 'AI æ™¶ç‰‡åœ¨ä¸€å¤©ä¸­é€²è¡Œè¨“ç·´æˆ–æŽ¨è«–ä»»å‹™çš„å¹³å‡æ™‚é–“ï¼Œå»ºè­°å€¼ç‚º 24 å°æ™‚ã€‚',
            'lca-carbon-intensity-label': 'é›»ç¶²ç¢³å¼·åº¦ (kgCOâ‚‚e/kWh)',
            'lca-carbon-intensity-tooltip': 'æ¯ç”¢ç”Ÿä¸€åº¦é›»æ‰€ç”¢ç”Ÿçš„ç¢³æŽ’æ”¾é‡ã€‚å°ç£ 2022 å¹´å¹³å‡å€¼ç´„ç‚º 0.416 kgCOâ‚‚e/kWhã€‚',
            'calculateLcaBtn': 'é–‹å§‹è¨ˆç®—',
            'lca-results-title': 'è¨ˆç®—çµæžœ',
            'lca-total-co2-label': 'ç¸½ç¢³è¶³è·¡',
            'lca-total-co2-tooltip': 'æ™¶ç‰‡åœ¨æ•´å€‹ç”Ÿå‘½é€±æœŸä¸­ç”¢ç”Ÿçš„æº«å®¤æ°£é«”ç¸½æŽ’æ”¾é‡ï¼ŒåŒ…å«è£½é€ èˆ‡é‹ä½œéšŽæ®µã€‚',
            'lca-water-label': 'æ°´è³‡æºæ¶ˆè€—',
            'lca-water-tooltip': 'æ™¶ç‰‡åœ¨å…¶ä½¿ç”¨å£½å‘½å…§ï¼Œæ–¼è£½é€ åŠé‹ä½œéŽç¨‹ä¸­æ¶ˆè€—çš„ç¸½æ°´é‡ã€‚',
            'lca-ewaste-label': 'é›»å­å»¢æ£„ç‰©',
            'lca-ewaste-tooltip': 'æ™¶ç‰‡åœ¨ç”Ÿå‘½é€±æœŸçµæŸå¾Œç”¢ç”Ÿçš„å»¢æ£„ç‰©é‡é‡ï¼Œé€šå¸¸æŒ‡ç”¢å“æœ¬èº«çš„é‡é‡ã€‚',
            'lca-breakdown-title': 'ç¢³æŽ’ç´°é …åˆ†æž',
            'lca-op-co2-label': 'ç‡Ÿé‹ç¢³æŽ’',
            'lca-op-co2-tooltip': 'æ™¶ç‰‡åœ¨é‹ä½œæœŸé–“ï¼Œå› é›»åŠ›æ¶ˆè€—æ‰€ç”¢ç”Ÿçš„ç¢³æŽ’ã€‚',
            'lca-em-co2-label': 'éš±å«ç¢³æŽ’',
            'lca-em-co2-tooltip': 'æ™¶ç‰‡åœ¨è£½é€ ã€é‹è¼¸åŠæ£„ç½®éšŽæ®µæ‰€ç”¢ç”Ÿçš„ç¢³æŽ’ã€‚',
            'lca-equivalents-title': 'æ—¥å¸¸æ›ç®—',
            'training-settings-title': 'åƒæ•¸è¨­å®š',
            'training-model-settings-title': '1. LLM æ¨¡åž‹è¨­å®š',
            'training-preset-label': 'æ¨¡åž‹é è¨­',
            'training-model-type-label': 'æ¨¡åž‹é¡žåž‹',
            'training-model-type-dense': 'Dense (å¯†é›†æ¨¡åž‹)',
            'training-model-type-moe': 'MoE (å°ˆå®¶æ··åˆæ¨¡åž‹)',
            'training-total-params-label': 'ç¸½åƒæ•¸æ•¸é‡ (B)',
            'training-total-params-tooltip': 'æ¨¡åž‹çš„ç¸½åƒæ•¸æ•¸é‡ï¼Œå–®ä½ç‚ºåå„„ (Billion)ã€‚',
            'training-base-params-label': 'åŸºç¤Žæ¨¡åž‹åƒæ•¸ (B)',
            'training-base-params-tooltip': 'å°æ–¼ MoE æ¨¡åž‹ï¼Œå…¶å°æ‡‰çš„å¯†é›†åŸºç¤Žæ¨¡åž‹åƒæ•¸æ•¸é‡ã€‚',
            'training-tokens-label': 'è™•ç† Token æ•¸é‡ (B)',
            'training-tokens-tooltip': 'æ¨¡åž‹åœ¨è¨“ç·´æˆ–æŽ¨è«–éŽç¨‹ä¸­è™•ç†çš„ Token ç¸½æ•¸ï¼Œå–®ä½ç‚ºåå„„ (Billion)ã€‚',
            'training-hardware-settings-title': '2. ç¡¬é«”èˆ‡è³‡æ–™ä¸­å¿ƒè¨­å®š',
            'training-device-label': 'é‹ç®—è£ç½®',
            'training-device-custom': 'è‡ªè¨‚',
            'training-device-num-label': 'è£ç½®æ•¸é‡',
            'training-power-label': 'å¹³å‡ç³»çµ±åŠŸè€— (W/è£ç½®)',
            'training-power-tooltip': 'æ¯å°é‹ç®—è£ç½®ï¼ˆåŒ…å«ä¸»æ©Ÿã€è¨˜æ†¶é«”ç­‰ï¼‰çš„å¹³å‡ç¸½åŠŸè€—ã€‚',
            'training-efficiency-label': 'ç¡¬é«”æ•ˆçŽ‡ (%)',
            'training-efficiency-tooltip': 'å¯¦éš›é‹ç®—åžåé‡ç›¸å°æ–¼ç†è«–å³°å€¼åžåé‡çš„ç™¾åˆ†æ¯”ã€‚',
            'training-pue-label': 'PUE',
            'training-pue-tooltip': 'é›»åŠ›ä½¿ç”¨æ•ˆçŽ‡ (Power Usage Effectiveness)ï¼Œè³‡æ–™ä¸­å¿ƒç¸½è€—èƒ½èˆ‡ IT è¨­å‚™è€—èƒ½çš„æ¯”å€¼ï¼Œè¶ŠæŽ¥è¿‘ 1 æ•ˆçŽ‡è¶Šé«˜ã€‚',
            'training-ci-label': 'ç¢³å¼·åº¦ (kgCOâ‚‚eq/kWh)',
            'training-ci-tooltip': 'è³‡æ–™ä¸­å¿ƒæ¯æ¶ˆè€—ä¸€åº¦é›»ï¼ˆkWhï¼‰æ‰€ç”¢ç”Ÿçš„äºŒæ°§åŒ–ç¢³ç•¶é‡(å…¬æ–¤)ã€‚é è¨­å€¼ç‚ºç¾Žåœ‹å¹³å‡ã€‚',
            'training-cost-label': 'GPU å–®ä½æˆæœ¬ ($/å°æ™‚)',
            'training-cost-tooltip': 'å–®ä¸€ GPU æ¯å°æ™‚çš„é‹ç®—æˆæœ¬ã€‚é è¨­å€¼åƒè€ƒ Microsoft Azure V100 éš¨ç”¨éš¨ä»˜åƒ¹æ ¼ã€‚',
            'calculateTrainingBtn': 'é–‹å§‹è¨ˆç®—',
            'training-results-title': 'è¨ˆç®—çµæžœ',
            'training-co2-label': 'è¨“ç·´ç¢³æŽ’',
            'training-co2-tooltip': 'æ¨¡åž‹è¨“ç·´æœŸé–“ï¼Œå› é›»åŠ›æ¶ˆè€—æ‰€ç”¢ç”Ÿçš„ç¢³æŽ’ã€‚',
            'training-energy-label': 'ç¸½æ¶ˆè€—é›»é‡',
            'training-energy-tooltip': 'æ¨¡åž‹è¨“ç·´æœŸé–“ï¼Œè³‡æ–™ä¸­å¿ƒç¸½å…±æ¶ˆè€—çš„é›»é‡ã€‚',
            'training-duration-label': 'é ä¼°è¨“ç·´æ™‚é–“',
            'training-duration-tooltip': 'æ¨¡åž‹å®Œæˆè¨“ç·´æ‰€éœ€çš„ç¸½æ™‚é–“ã€‚',
            'training-cost-est-label': 'é ä¼°è¨“ç·´æˆæœ¬',
            'training-cost-est-tooltip': 'æ¨¡åž‹è¨“ç·´æœŸé–“æ‰€éœ€çš„ç¡¬é«”ç§Ÿç”¨æˆæœ¬ (USD)ã€‚',
            'training-equivalents-title': 'æ—¥å¸¸æ›ç®—',
            'inf-settings-title': 'åƒæ•¸è¨­å®š',
            'inf-model-settings-title': '1. LLM æ¨¡åž‹è¨­å®š',
            'inf-preset-label': 'é¸æ“‡é è¨­æ¨¡åž‹',
            'inf-preset-custom': 'è‡ªè¨‚',
            'inf-tokens-label': 'è™•ç† Token æ•¸é‡',
            'inf-tokens-tooltip': 'æ ¹æ“šå¸¸è¦‹ä»»å‹™é¡žåž‹é è¨­çš„ Token æ•¸é‡ã€‚',
            'inf-task-rag': 'å•ç­” (RAG) (ç´„ 5k tokens)',
            'inf-task-translation': 'ç¿»è­¯ (ç´„ 50k tokens)',
            'inf-task-code': 'ç¨‹å¼ç¢¼ç”Ÿæˆ/Debug (ç´„ 20k tokens)',
            'inf-task-summary': 'æ–‡ä»¶æ‘˜è¦ (ç´„ 150k tokens)',
            'inf-model-type-label': 'æ¨¡åž‹é¡žåž‹',
            'inf-model-type-dense': 'Dense (å¯†é›†æ¨¡åž‹)',
            'inf-model-type-moe': 'MoE (å°ˆå®¶æ··åˆæ¨¡åž‹)',
            'inf-total-params-label': 'ç¸½åƒæ•¸æ•¸é‡ (B)',
            'inf-total-params-tooltip': 'æ¨¡åž‹çš„ç¸½åƒæ•¸æ•¸é‡ï¼Œå–®ä½ç‚ºåå„„ (Billion)ã€‚',
            'inf-base-params-label': 'åŸºç¤Žæ¨¡åž‹åƒæ•¸ (B)',
            'inf-base-params-tooltip': 'å°æ–¼ MoE æ¨¡åž‹ï¼Œå…¶å°æ‡‰çš„å¯†é›†åŸºç¤Žæ¨¡åž‹åƒæ•¸æ•¸é‡ã€‚',
            'inf-hardware-settings-title': '2. ç¡¬é«”èˆ‡è³‡æ–™ä¸­å¿ƒè¨­å®š',
            'inf-device-label': 'é‹ç®—è£ç½®',
            'inf-device-custom': 'è‡ªè¨‚',
            'inf-device-num-label': 'è£ç½®æ•¸é‡',
            'inf-power-label': 'å¹³å‡ç³»çµ±åŠŸè€— (W/è£ç½®)',
            'inf-power-tooltip': 'æ¯å°é‹ç®—è£ç½®ï¼ˆåŒ…å«ä¸»æ©Ÿã€è¨˜æ†¶é«”ç­‰ï¼‰çš„å¹³å‡ç¸½åŠŸè€—ã€‚',
            'inf-efficiency-label': 'ç¡¬é«”æ•ˆçŽ‡ (%)',
            'inf-efficiency-tooltip': 'å¯¦éš›é‹ç®—åžåé‡ç›¸å°æ–¼ç†è«–å³°å€¼åžåé‡çš„ç™¾åˆ†æ¯”ã€‚',
            'inf-pue-label': 'PUE',
            'inf-pue-tooltip': 'é›»åŠ›ä½¿ç”¨æ•ˆçŽ‡ (Power Usage Effectiveness)ï¼Œè³‡æ–™ä¸­å¿ƒç¸½è€—èƒ½èˆ‡ IT è¨­å‚™è€—èƒ½çš„æ¯”å€¼ï¼Œè¶ŠæŽ¥è¿‘ 1 æ•ˆçŽ‡è¶Šé«˜ã€‚',
            'inf-ci-label': 'ç¢³å¼·åº¦ (gCOâ‚‚eq/kWh)',
            'inf-ci-tooltip': 'è³‡æ–™ä¸­å¿ƒæ¯æ¶ˆè€—ä¸€åº¦é›»ï¼ˆkWhï¼‰æ‰€ç”¢ç”Ÿçš„äºŒæ°§åŒ–ç¢³ç•¶é‡ã€‚é è¨­å€¼ç‚ºç¾Žåœ‹å¹³å‡ã€‚',
            'calculateInferenceBtn': 'é–‹å§‹è¨ˆç®—',
            'inf-results-title': 'è¨ˆç®—çµæžœ',
            'inf-total-co2-label': 'ç¸½ç¢³è¶³è·¡ (gCOâ‚‚eq)',
            'inf-total-co2-tooltip': 'æ¨¡åž‹åœ¨æŽ¨è«–ä»»å‹™ä¸­ï¼Œå› é›»åŠ›æ¶ˆè€—æ‰€ç”¢ç”Ÿçš„ç¸½ç¢³æŽ’ã€‚',
            'inf-details-title': 'è©³ç´°è³‡è¨Š',
            'inf-time-label': 'é ä¼°æŽ¨è«–æ™‚é–“',
            'inf-time-tooltip': 'æ¨¡åž‹å®ŒæˆæŽ¨è«–æ‰€éœ€çš„ç¸½æ™‚é–“ã€‚',
            'inf-energy-label': 'ç¸½æ¶ˆè€—é›»é‡',
            'inf-energy-tooltip': 'æ¨¡åž‹æŽ¨è«–æœŸé–“ï¼Œè³‡æ–™ä¸­å¿ƒç¸½å…±æ¶ˆè€—çš„é›»é‡ã€‚',
            'inf-equivalents-title': 'æ—¥å¸¸æ›ç®—',
            'unit_days': 'å¤©',
            'unit_years': 'å¹´',
            'unit_ms': 'æ¯«ç§’',
            'unit_s': 'ç§’',
            'unit_min': 'åˆ†é˜',
            'unit_hr': 'å°æ™‚',
            'alert_invalid_input': 'è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å€¼ã€‚',
            'chart_op_label': 'ç‡Ÿé‹ç¢³æŽ’',
            'chart_em_label': 'éš±å«ç¢³æŽ’',
            'chart_title': 'ç¢³è¶³è·¡çµ„æˆ (tCOâ‚‚eq)',
            'model_preset_custom_name': 'è‡ªè¨‚æ¨¡åž‹',
        },
    };
    const equivalentsData = {
        en: {
            lca: {
                flight: { name: 'Taipei-Tokyo flights', value: 0.4, icon: `âœˆï¸`, tooltip: 'Carbon emissions from a round-trip flight between Taipei and Tokyo.' },
                car: { name: 'cars\' annual emissions', value: 1.9, icon: `ðŸš—`, tooltip: 'Average annual carbon emissions from a typical passenger car.' },
                tree: { name: 'trees\' annual absorption', value: 0.012, icon: `ðŸŒ³`, tooltip: 'Total amount of carbon dioxide a single tree can absorb in a year.' },
                bento: { name: 'pork chop bento boxes', value: 0.0015, icon: `ðŸ±`, tooltip: 'Carbon emissions from the production to consumption of a pork chop bento box.' },
            },
            training: {
                flight: { name: 'Taipei-Tokyo flights', value: 0.4, icon: `âœˆï¸`, tooltip: 'Carbon emissions from a round-trip flight between Taipei and Tokyo.' },
                car: { name: 'cars\' annual emissions', value: 1.9, icon: `ðŸš—`, tooltip: 'Average annual carbon emissions from a typical passenger car.' },
                tree: { name: 'trees\' annual absorption', value: 0.012, icon: `ðŸŒ³`, tooltip: 'Total amount of carbon dioxide a single tree can absorb in a year.' },
                bento: { name: 'pork chop bento boxes', value: 0.0015, icon: `ðŸ±`, tooltip: 'Carbon emissions from the production to consumption of a pork chop bento box.' },
            },
            inference: {
                'sms': { name: 'SMS messages', value: 0.014, icon: `ðŸ’¬`, tooltip: 'Average carbon footprint of one SMS message.' },
                'google_search': { name: 'Google searches', value: 0.2, icon: `ðŸ”`, tooltip: 'Average carbon footprint of one Google search.' },
                'youtube_stream': { name: 'hours of YouTube streaming', value: 10, icon: `â–¶ï¸`, tooltip: 'Average carbon footprint of streaming one hour of YouTube video.' },
                'video_conference': { name: 'hours of online meetings', value: 12, icon: `ðŸ’»`, tooltip: 'Average carbon footprint of a one-hour online video conference.' },
            }
        },
        zh: {
            lca: {
                flight: { name: 'è¶Ÿå°åŒ—-æ±äº¬èˆªç­', value: 0.4, icon: `âœˆï¸`, tooltip: 'ä¸€è¶Ÿå°åŒ—é£›å¾€æ±äº¬çš„ä¾†å›žèˆªç­æ‰€ç”¢ç”Ÿçš„ç¢³æŽ’ã€‚' },
                car: { name: 'è¼›æ±½è»Šå¹´æŽ’ç¢³', value: 1.9, icon: `ðŸš—`, tooltip: 'ä¸€è¼›æ™®é€šå®¶ç”¨æ±½è»Šè¡Œé§›ä¸€å¹´æ‰€ç”¢ç”Ÿçš„å¹³å‡ç¢³æŽ’ã€‚' },
                tree: { name: 'æ£µæ¨¹å¹´å¸ç¢³é‡', value: 0.012, icon: `ðŸŒ³`, tooltip: 'ä¸€æ£µæ¨¹ä¸€å¹´æ‰€èƒ½å¸æ”¶çš„äºŒæ°§åŒ–ç¢³ç¸½é‡ã€‚' },
                bento: { name: 'å€‹æŽ’éª¨ä¾¿ç•¶', value: 0.0015, icon: `ðŸ±`, tooltip: 'ä¸€å€‹æŽ’éª¨ä¾¿ç•¶å¾žç”Ÿç”¢åˆ°æ¶ˆè²»æ‰€ç”¢ç”Ÿçš„ç¢³æŽ’ã€‚' },
            },
            training: {
                flight: { name: 'è¶Ÿå°åŒ—-æ±äº¬èˆªç­', value: 0.4, icon: `âœˆï¸`, tooltip: 'ä¸€è¶Ÿå°åŒ—é£›å¾€æ±äº¬çš„ä¾†å›žèˆªç­æ‰€ç”¢ç”Ÿçš„ç¢³æŽ’ã€‚' },
                car: { name: 'è¼›æ±½è»Šå¹´æŽ’ç¢³', value: 1.9, icon: `ðŸš—`, tooltip: 'ä¸€è¼›æ™®é€šå®¶ç”¨æ±½è»Šè¡Œé§›ä¸€å¹´æ‰€ç”¢ç”Ÿçš„å¹³å‡ç¢³æŽ’ã€‚' },
                tree: { name: 'æ£µæ¨¹å¹´å¸ç¢³é‡', value: 0.012, icon: `ðŸŒ³`, tooltip: 'ä¸€æ£µæ¨¹ä¸€å¹´æ‰€èƒ½å¸æ”¶çš„äºŒæ°§åŒ–ç¢³ç¸½é‡ã€‚' },
                bento: { name: 'å€‹æŽ’éª¨ä¾¿ç•¶', value: 0.0015, icon: `ðŸ±`, tooltip: 'ä¸€å€‹æŽ’éª¨ä¾¿ç•¶å¾žç”Ÿç”¢åˆ°æ¶ˆè²»æ‰€ç”¢ç”Ÿçš„ç¢³æŽ’ã€‚' },
            },
            inference: {
                'sms': { name: 'å€‹ç°¡è¨Š', value: 0.014, icon: `ðŸ’¬`, tooltip: 'ä¸€å‰‡ç°¡è¨Šçš„å¹³å‡ç¢³æŽ’ã€‚' },
                'google_search': { name: 'æ¬¡ Google æœå°‹', value: 0.2, icon: `ðŸ”`, tooltip: 'ä¸€æ¬¡ Google æœå°‹çš„å¹³å‡ç¢³æŽ’ã€‚' },
                'youtube_stream': { name: 'å°æ™‚ YouTube ä¸²æµ', value: 10, icon: `â–¶ï¸`, tooltip: 'è§€çœ‹ä¸€å°æ™‚ YouTube å½±ç‰‡çš„å¹³å‡ç¢³æŽ’ã€‚' },
                'video_conference': { name: 'å°æ™‚ç·šä¸Šæœƒè­°', value: 12, icon: `ðŸ’»`, tooltip: 'ä¸€å°æ™‚ç·šä¸Šè¦–è¨Šæœƒè­°çš„å¹³å‡ç¢³æŽ’ã€‚' },
            }
        }
    };

    function setLanguage(lang) {
        if (!translations[lang]) return;
        currentLanguage = lang;
        document.documentElement.lang = lang === 'zh' ? 'zh-TW' : 'en';

        // Update button styles
        document.getElementById('lang-zh').classList.toggle('active-lang', lang === 'zh');
        document.getElementById('lang-en').classList.toggle('active-lang', lang === 'en');

        // Translate all elements with an ID
        const langData = translations[lang];
        document.querySelectorAll('[id]').forEach(element => {
            const key = element.id;
            if (langData[key]) {
                // Use innerHTML for elements that might contain other elements like tooltips
                // and textContent for simple text nodes or buttons.
                if (element.querySelector('.tooltip')) {
                     // This logic assumes the text node is the first child
                    element.childNodes[0].nodeValue = langData[key];
                } else {
                    element.textContent = langData[key];
                }
            }
        });
        
        // Update dynamic content like model presets
        populateModelPresets();
    }
    
    document.getElementById('lang-zh').addEventListener('click', () => setLanguage('zh'));
    document.getElementById('lang-en').addEventListener('click', () => setLanguage('en'));


    // --- é ç±¤åˆ‡æ›é‚è¼¯ ---
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const targetTab = button.dataset.tab;
            tabButtons.forEach(btn => {
                btn.classList.remove('active-tab', 'text-indigo-600', 'dark:text-indigo-400', 'border-indigo-500');
                btn.classList.add('inactive-tab', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'dark:text-gray-400', 'dark:hover:text-gray-300', 'dark:hover:border-gray-500');
            });
            button.classList.add('active-tab', 'text-indigo-600', 'dark:text-indigo-400', 'border-indigo-500');
            button.classList.remove('inactive-tab', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'dark:text-gray-400', 'dark:hover:text-gray-300', 'dark:hover:border-gray-500');
            tabContents.forEach(content => {
                content.id === targetTab ? content.classList.remove('hidden') : content.classList.add('hidden');
            });
        });
    });
    
    // --- é€šç”¨å‡½å¼ ---
    function animateValue(element, start, end, duration, unit = '', isCurrency = false, isDuration = false) {
         if (!element) return;
        let startTimestamp = null;
        const step = timestamp => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            const currentValue = progress * (end - start) + start;
            if (isCurrency) {
                element.textContent = `$${Math.floor(currentValue).toLocaleString('en-US')}`;
            } else if (isDuration) {
                const years = currentValue / 365;
                const days = currentValue;
                const unitYears = translations[currentLanguage].unit_years;
                const unitDays = translations[currentLanguage].unit_days;
                element.textContent = currentValue < 365 ? `${days.toFixed(2)} ${unitDays}` : `${years.toFixed(2)} ${unitYears}`;
            } else {
                element.innerHTML = `${currentValue.toFixed(2)} <span class="text-base font-normal">${unit}</span>`;
            }
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };
        window.requestAnimationFrame(step);
    }

    // --- å·¥å…· 1: AI æ™¶ç‰‡ LCA è©•ä¼°é‚è¼¯ ---
    const lcaResultsContainerEl = document.getElementById('lca-results-container');
    const gpuData = {
        "A100": { tdp_watt: 400, cradle_to_gate_kg: 120, water_L_per_year: [1000, 6000], e_waste_kg: 2.5 },
        "H100": { tdp_watt: 700, cradle_to_gate_kg: 164, water_L_per_year: [2000, 8000], e_waste_kg: 3 },
        "B200": { tdp_watt: 1100, cradle_to_gate_kg: 284, water_L_per_year: [3500, 10000], e_waste_kg: 2.5 },
        "B300": { tdp_watt: 1300, cradle_to_gate_kg: 300, water_L_per_year: [3500, 15000], e_waste_kg: 3.5 }
    };
    
    let carbonChartInstance = null;
    
    function updateChart(operational, embodied) {
        const ctx = document.getElementById('carbonChart').getContext('2d');
        if (carbonChartInstance) carbonChartInstance.destroy();
        const langData = translations[currentLanguage];
        carbonChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: [langData.chart_op_label, langData.chart_em_label],
                datasets: [{ data: [operational, embodied], backgroundColor: ['#3B82F6', '#14B8A6'], borderColor: document.body.classList.contains('dark') ? '#1f2937' : '#FFFFFF', borderWidth: 4 }]
            },
            options: {
                responsive: true, cutout: '70%',
                plugins: {
                    legend: { position: 'bottom', labels: { color: document.body.classList.contains('dark') ? '#D1D5DB' : '#4B5563' } },
                    title: { display: true, text: langData.chart_title, color: document.body.classList.contains('dark') ? '#F9FAFB' : '#1F2937', font: { size: 16 } }
                }
            },
        });
    }

    function runLcaCalculation() {
        const gpuChip = document.getElementById('gpuChip').value;
        const lifespan = parseFloat(document.getElementById('lifespan').value);
        const utilization = parseFloat(document.getElementById('utilization').value);
        const carbonIntensity = parseFloat(document.getElementById('carbonIntensity').value);

        if (isNaN(lifespan) || isNaN(utilization) || isNaN(carbonIntensity) || lifespan <= 0 || utilization < 0 || utilization > 24 || carbonIntensity <= 0) {
            alert(translations[currentLanguage].alert_invalid_input);
            return;
        }

        const data = gpuData[gpuChip];
        const totalHours = lifespan * 365 * utilization;
        const totalKWH = (data.tdp_watt * totalHours) / 1000;
        const operationalCo2 = (totalKWH * carbonIntensity) / 1000;
        const embodiedCo2 = data.cradle_to_gate_kg / 1000;
        const totalCo2 = operationalCo2 + embodiedCo2;
        const avgWater = (data.water_L_per_year[0] + data.water_L_per_year[1]) / 2;
        const totalWater = avgWater * lifespan;
        const eWaste = data.e_waste_kg;

        document.getElementById('totalCo2').innerHTML = `${totalCo2.toFixed(2)} <span class="text-base font-normal">tCOâ‚‚eq</span>`;
        document.getElementById('operationalCo2').innerHTML = `${operationalCo2.toFixed(2)} <span class="text-base font-normal">tCOâ‚‚eq</span>`;
        document.getElementById('embodiedCo2').innerHTML = `${embodiedCo2.toFixed(2)} <span class="text-base font-normal">tCOâ‚‚eq</span>`;
        document.getElementById('waterConsumption').innerHTML = `${totalWater.toFixed(0).toLocaleString('en-US')} <span class="text-base font-normal">L</span>`;
        document.getElementById('eWaste').innerHTML = `${eWaste.toFixed(2)} <span class="text-base font-normal">kg</span>`;
        
        updateChart(operationalCo2, embodiedCo2);

        const equivalentsContainer = document.getElementById('lca-equivalents');
        equivalentsContainer.innerHTML = '';
        const lcaDailyEquivalents = equivalentsData[currentLanguage].lca;
        for (const key in lcaDailyEquivalents) {
            const item = lcaDailyEquivalents[key];
            const equivalentAmount = totalCo2 / item.value;
            equivalentsContainer.innerHTML += `<div class="bg-white dark:bg-gray-700 p-3 rounded-lg text-center transition duration-300 ease-in-out shadow-sm hover:shadow-lg transform hover:-translate-y-1 border dark:border-gray-600"><div class="tooltip"><span class="text-3xl">${item.icon}</span><span class="tooltiptext">${item.tooltip} Emissions: ${item.value.toFixed(4).replace(/0+$/, '').replace(/\.$/, '')} tCOâ‚‚eq</span></div><p class="text-xl font-bold text-gray-800 dark:text-gray-200 mt-2">${Math.round(equivalentAmount).toLocaleString('en-US')}</p><p class="text-xs text-gray-600 dark:text-gray-400 mt-1">${item.name}</p></div>`;
        }
    }
    
    document.getElementById('calculateLcaBtn').addEventListener('click', runLcaCalculation);

    // --- å·¥å…· 2: LLM è¨“ç·´ç¢³æŽ’è¨ˆç®—å™¨é‚è¼¯ ---
    const modelPresetSelect = document.getElementById('modelPreset');
    const modelTypeSelect = document.getElementById('modelType');
    const baseModelParamsContainer = document.getElementById('baseModelParamsContainer');
    const deviceTypeSelect = document.getElementById('deviceType');
    
    const modelPresets = {
        'GPT3': { name: 'GPT-3 (175B)', type: 'dense', params: 175, baseParams: '', tokens: 300, deviceType: 'V100', deviceNum: 10000 },
        'GPT4': { name: 'GPT-4 (1.8T)', type: 'MoE', params: 1800, baseParams: 111, tokens: 13000, deviceType: 'A100', deviceNum: 25000 },
        'custom': { name: 'Custom Model' },
    };
    const hardwarePresets = {
        'V100': { peakTFLOPs: 125, systemPower: 330 }, 'A100': { peakTFLOPs: 312, systemPower: 550 },
        'H100': { peakTFLOPs: 1979, systemPower: 800 }, 'TPUv3': { peakTFLOPs: 123, systemPower: 288 },
        'TPUv4': { peakTFLOPs: 275, systemPower: 250 }, 'custom': { peakTFLOPs: 125, systemPower: 330 }
    };

    function populateModelPresets() {
        modelPresetSelect.innerHTML = ''; // Clear existing options
        for (const key in modelPresets) {
            const option = document.createElement('option');
            option.value = key;
            if (key === 'custom') {
                option.textContent = translations[currentLanguage].model_preset_custom_name;
            } else {
                option.textContent = modelPresets[key].name;
            }
            modelPresetSelect.appendChild(option);
        }
    }

    function updateTrainingForm() {
        const selectedModelKey = modelPresetSelect.value;
        const preset = modelPresets[selectedModelKey];
        const isCustom = selectedModelKey === 'custom';

        if (!isCustom) {
            modelTypeSelect.value = preset.type;
            document.getElementById('parametersB').value = preset.params;
            document.getElementById('tokensB').value = preset.tokens;
            deviceTypeSelect.value = preset.deviceType;
            document.getElementById('deviceNum').value = preset.deviceNum;
            document.getElementById('systemPower').value = (hardwarePresets[preset.deviceType] || hardwarePresets['custom']).systemPower;
            if (preset.type === 'MoE') {
                document.getElementById('baseModelParamsB').value = preset.baseParams;
            } else {
                document.getElementById('baseModelParamsB').value = '';
            }
        }
        
        document.getElementById('modelType').disabled = !isCustom;
        document.getElementById('parametersB').disabled = !isCustom;
        document.getElementById('baseModelParamsB').disabled = !isCustom;
        document.getElementById('tokensB').disabled = !isCustom;
        
        baseModelParamsContainer.classList.toggle('hidden', modelTypeSelect.value !== 'MoE');
    }

    modelPresetSelect.addEventListener('change', updateTrainingForm);
    
    deviceTypeSelect.addEventListener('change', () => {
         document.getElementById('systemPower').value = (hardwarePresets[deviceTypeSelect.value] || hardwarePresets['custom']).systemPower;
    });
    
    function runTrainingCalculation() {
        const inputs = {
            modelType: modelTypeSelect.value,
            parametersB: parseFloat(document.getElementById('parametersB').value),
            baseModelParamsB: parseFloat(document.getElementById('baseModelParamsB').value),
            tokensB: parseFloat(document.getElementById('tokensB').value),
            deviceType: deviceTypeSelect.value,
            deviceNum: parseInt(document.getElementById('deviceNum').value),
            systemPower: parseFloat(document.getElementById('systemPower').value),
            hardwareEfficiency: parseFloat(document.getElementById('hardwareEfficiency').value),
            pue: parseFloat(document.getElementById('pue').value),
            co2eqkwh: parseFloat(document.getElementById('trainingCo2eqkwh').value),
            gpuCostPerHour: parseFloat(document.getElementById('gpuCostPerHour').value),
        };

        let isValid = true;
        for (const key in inputs) {
            if (inputs.modelType === 'dense' && key === 'baseModelParamsB') continue;
            if (['modelType', 'deviceType'].includes(key)) continue;
            if (isNaN(inputs[key])) { isValid = false; break; }
            if (inputs[key] <= 0 && key !== 'baseModelParamsB') { isValid = false; break; }
        }
        if (inputs.modelType === 'MoE' && (isNaN(inputs.baseModelParamsB) || inputs.baseModelParamsB <= 0)) {
            isValid = false;
        }

        if (!isValid) {
            alert(translations[currentLanguage].alert_invalid_input);
            return;
        }

        const activeParamsB = inputs.modelType === 'MoE' ? inputs.baseModelParamsB : inputs.parametersB;
        const totalFLOPs = 6 * activeParamsB * 1e9 * inputs.tokensB * 1e9;
        const TFLOPsPerSecond = hardwarePresets[inputs.deviceType].peakTFLOPs * (inputs.hardwareEfficiency / 100);
        const trainingSeconds = totalFLOPs / (inputs.deviceNum * TFLOPsPerSecond * 1e12);
        const trainingDays = trainingSeconds / 86400;
        const totalPowerKW = (inputs.systemPower * inputs.deviceNum) / 1000;
        const totalEnergyKWh = totalPowerKW * (trainingDays * 24) * inputs.pue;
        
        const results = {
            operationalCo2: (totalEnergyKWh * inputs.co2eqkwh) / 1000,
            trainingDays: trainingDays,
            totalEnergyMWh: totalEnergyKWh / 1000,
            trainingCost: trainingDays * 24 * inputs.deviceNum * inputs.gpuCostPerHour,
        };
        
        animateValue(document.getElementById('operationalCo2Display'), 0, results.operationalCo2, 500, 'tCOâ‚‚eq');
        animateValue(document.getElementById('totalEnergyMWhDisplay'), 0, results.totalEnergyMWh, 500, 'MWh');
        animateValue(document.getElementById('trainingCostDisplay'), 0, results.trainingCost, 500, '', true);
        animateValue(document.getElementById('trainingDurationDisplay'), 0, results.trainingDays, 500, '', false, true);
        
        const equivalentsContainer = document.getElementById('training-equivalents');
        equivalentsContainer.innerHTML = '';
        const trainingDailyEquivalents = equivalentsData[currentLanguage].training;
        for (const key in trainingDailyEquivalents) {
            const item = trainingDailyEquivalents[key];
            const equivalentAmount = results.operationalCo2 / item.value;
            equivalentsContainer.innerHTML += `<div class="bg-white dark:bg-gray-700 p-3 rounded-lg text-center transition duration-300 ease-in-out shadow-sm hover:shadow-lg transform hover:-translate-y-1 border dark:border-gray-600"><div class="tooltip"><span class="text-3xl">${item.icon}</span><span class="tooltiptext">${item.tooltip} Emissions: ${item.value.toFixed(4).replace(/0+$/, '').replace(/\.$/, '')} tCOâ‚‚eq</span></div><p class="text-xl font-bold text-gray-800 dark:text-gray-200 mt-2">${Math.round(equivalentAmount).toLocaleString('en-US')}</p><p class="text-xs text-gray-600 dark:text-gray-400 mt-1">${item.name}</p></div>`;
        }
    }
    
    document.getElementById('calculateTrainingBtn').addEventListener('click', runTrainingCalculation);


    // --- å·¥å…· 3: LLM æŽ¨è«–ç¢³æŽ’è¨ˆç®—å™¨é‚è¼¯ ---
    const infModelPresetSelect = document.getElementById('inf-modelPreset');
    const infCustomModelSection = document.getElementById('inf-customModelSection');
    const infModelTypeSelect = document.getElementById('inf-modelType');
    const infBaseModelParamsContainer = document.getElementById('inf-baseModelParamsContainer');
    const infDeviceTypeSelect = document.getElementById('inf-deviceType');
    
    const infModelPresets = {
        'GPT3': { parametersB: 175, type: 'dense', baseModelParamsB: null, deviceType: 'A100', deviceNum: 8, systemPower: 550 },
        'GPT4': { parametersB: 1800, type: 'MoE', baseModelParamsB: 200, deviceType: 'A100', deviceNum: 16, systemPower: 550 },
        'custom': { parametersB: 175, type: 'dense', baseModelParamsB: null, deviceType: 'V100', deviceNum: 1, systemPower: 330 }
    };
    const infHardwarePresets = {
        'V100': { peakTFLOPs: 125, systemPower: 330 }, 'H100': { peakTFLOPs: 1979, systemPower: 800 },
        'A100': { peakTFLOPs: 312, systemPower: 550 }, 'TPUv3': { peakTFLOPs: 123, systemPower: 288 },
        'TPUv4': { peakTFLOPs: 275, systemPower: 250 }, 'custom': { peakTFLOPs: 125, systemPower: 330 }
    };
    
    function updateInferenceForm() {
        const presetKey = infModelPresetSelect.value;
        const isCustom = presetKey === 'custom';
        const model = infModelPresets[presetKey];

        document.getElementById('inf-parametersB').value = model.parametersB;
        infModelTypeSelect.value = model.type;
        if (model.type === 'MoE') {
            document.getElementById('inf-baseModelParamsB').value = model.baseModelParamsB;
        }
        infDeviceTypeSelect.value = model.deviceType;
        document.getElementById('inf-deviceNum').value = model.deviceNum;
        document.getElementById('inf-systemPower').value = model.systemPower;
        
        infCustomModelSection.classList.toggle('hidden', !isCustom);
        document.getElementById('inf-modelType').disabled = !isCustom;
        document.getElementById('inf-parametersB').disabled = !isCustom;
        document.getElementById('inf-baseModelParamsB').disabled = !isCustom;
        
        infBaseModelParamsContainer.classList.toggle('hidden', infModelTypeSelect.value !== 'MoE');
    }

    infModelPresetSelect.addEventListener('change', updateInferenceForm);
    
    infDeviceTypeSelect.addEventListener('change', () => {
        if (infDeviceTypeSelect.value !== 'custom') {
            document.getElementById('inf-systemPower').value = infHardwarePresets[infDeviceTypeSelect.value].systemPower;
        }
    });
    
    function runInferenceCalculation() {
        const inputs = {
            modelType: infModelTypeSelect.value,
            parametersB: parseFloat(document.getElementById('inf-parametersB').value),
            baseModelParamsB: parseFloat(document.getElementById('inf-baseModelParamsB').value),
            tokensT: parseFloat(document.getElementById('inf-tokensT').value),
            deviceType: infDeviceTypeSelect.value,
            deviceNum: parseInt(document.getElementById('inf-deviceNum').value),
            systemPower: parseFloat(document.getElementById('inf-systemPower').value),
            hardwareEfficiency: parseFloat(document.getElementById('inf-hardwareEfficiency').value),
            pue: parseFloat(document.getElementById('inf-pue').value),
            co2eqkwh: parseFloat(document.getElementById('inf-co2eqkwh').value),
        };

        let isValid = true;
        for (const key in inputs) {
            if (key === 'baseModelParamsB' && inputs.modelType !== 'MoE') continue;
            if (['modelType', 'deviceType'].includes(key)) continue;
            if (isNaN(inputs[key])) { isValid = false; break; }
            if (inputs[key] < 0) { isValid = false; break; }
        }
         if (inputs.pue < 1) { isValid = false; }
         if (inputs.deviceNum < 1) { isValid = false; }
        
        if(!isValid) {
            alert(translations[currentLanguage].alert_invalid_input);
            return;
        }

        const activeParamsB = inputs.modelType === 'MoE' ? inputs.baseModelParamsB : inputs.parametersB;
        const totalZettaFLOPs = 2 * activeParamsB * inputs.tokensT;
        const totalFLOPs = totalZettaFLOPs * 1e21;
        const TFLOPsPerSecond = infHardwarePresets[inputs.deviceType].peakTFLOPs * (inputs.hardwareEfficiency / 100);
        const inferenceSeconds = totalFLOPs / (inputs.deviceNum * TFLOPsPerSecond * 1e12);
        const totalPowerKW = (inputs.systemPower * inputs.deviceNum) / 1000;
        const totalEnergyKWh = totalPowerKW * (inferenceSeconds / 3600) * inputs.pue;
        const results = { totalCo2_g: totalEnergyKWh * inputs.co2eqkwh, totalEnergyKWh, totalTimeSeconds: inferenceSeconds };
        
        document.getElementById('inf-totalCo2').textContent = results.totalCo2_g.toFixed(4);
        
        const { totalTimeSeconds } = results;
        let timeString;
        const langData = translations[currentLanguage];
        if (totalTimeSeconds < 1) timeString = `${(totalTimeSeconds * 1000).toFixed(2)} ${langData.unit_ms}`;
        else if (totalTimeSeconds < 60) timeString = `${totalTimeSeconds.toFixed(2)} ${langData.unit_s}`;
        else if (totalTimeSeconds < 3600) timeString = `${(totalTimeSeconds / 60).toFixed(2)} ${langData.unit_min}`;
        else timeString = `${(totalTimeSeconds / 3600).toFixed(2)} ${langData.unit_hr}`;
        document.getElementById('inf-timeDisplay').textContent = timeString;
        
        document.getElementById('inf-energyDisplay').textContent = `${(results.totalEnergyKWh * 1000).toFixed(2)} Wh`;
        
        const equivalentsContainer = document.getElementById('inf-equivalents');
        equivalentsContainer.innerHTML = '';
        const infDailyEquivalents_g = equivalentsData[currentLanguage].inference;
        for (const key in infDailyEquivalents_g) {
            const item = infDailyEquivalents_g[key];
            const equivalentAmount = results.totalCo2_g / item.value;
            const formattedAmount = equivalentAmount < 1 && equivalentAmount > 0 ? equivalentAmount.toFixed(4) : Math.round(equivalentAmount).toLocaleString('en-US');
            equivalentsContainer.innerHTML += `<div class="bg-white dark:bg-gray-700 p-3 rounded-lg text-center transition duration-300 ease-in-out shadow-sm hover:shadow-lg transform hover:-translate-y-1 border dark:border-gray-600"><div class="tooltip"><span class="text-3xl">${item.icon}</span><span class="tooltiptext">${item.tooltip} Emissions: ${item.value.toFixed(4).replace(/0+$/, '').replace(/\.$/, '')} gCOâ‚‚eq</span></div><p class="text-xl font-bold text-gray-800 dark:text-gray-200 mt-2">${formattedAmount}</p><p class="text-xs text-gray-600 dark:text-gray-400 mt-1">${item.name}</p></div>`;
        }
    }

    document.getElementById('calculateInferenceBtn').addEventListener('click', runInferenceCalculation);
    
    // --- Initial Setup ---
    setLanguage('zh'); // Set default language
    updateTrainingForm();
    updateInferenceForm();
    document.querySelectorAll('.results-container').forEach(container => {
        container.style.opacity = '1';
    });
});
